version: '2'
services:
  nginx:
    image: becram/olen-elib-nginx:v1.2
    restart: always
    hostname: nginx
    container_name: prod_nginx_01
    networks:
      - pustakalaya-prod-network
    ports:
     - "80:8000"
    volumes:
     - ./src:/src
     - /library/media_root:/library/media_root
     - /library/static_root:/library/static_root
    depends_on:
     - web
  web:
    image: becram/olen-elib-code:v1.3
    restart: always
    hostname: web
    container_name: prod_django_web_01
    depends_on:
      - db
      - elastic
    volumes:
#      - ./src:/src
      - /library/media_root:/library/media_root
      - /library/static_root:/library/static_root
    networks:
      - pustakalaya-prod-network
    expose:
      - "8001"
  db:
    image: becram/olen-elib-db:v1.2
    restart: always
    environment:
      - POSTGRES_USER=pustakalaya_user
      - POSTGRES_DB=pustakalaya
      - POSTGRES_PASSWORD=pustakalaya123
      - POSTGRES_BACKUP_DIR=/pg_backups
    hostname: db
    container_name: prod_postgres_01
    networks:
      - pustakalaya-prod-network
    volumes:
      - /library/backup_pg_pustakalaya:/pg_backups
      - ./src:/src

  elastic:
    image: becram/olen-elib-elastic:v1.2
    hostname: elastic
    restart: always
    container_name: prod_elasticsearch_01
    volumes:
      - ./conf:/conf
    networks:
      - pustakalaya-prod-network
    # command: ./run_db.sh
    depends_on:
      - db

  rabbitmq:
    image: rabbitmq:3.7
    hostname: rabbitmq
    restart: always
    container_name: prod_rabbitmq_01
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=mypass
    networks:
      - pustakalaya-prod-network

  celery:
    image: becram/olen-elib-celery:v1.2
    hostname: celery
    restart: always
    container_name: prod_celery_01
    networks:
      - pustakalaya-prod-network
    volumes:
      - ./src:/src
      - /library/media_root:/library/media_root
      - /library/static_root:/library/static_root

    links:
      - db
      - rabbitmq



networks:
  pustakalaya-prod-network:
    driver: bridge
